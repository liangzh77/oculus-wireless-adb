# 🚀 构建和测试指南

## 📋 构建前检查清单

在构建之前，确认以下项目：

- [x] UI 已创建（ADB Control Canvas）
- [x] ADBManager GameObject 已存在
- [x] 所有脚本已附加并关联
- [x] 所需文件都在正确位置：
  - [x] `Assets/Plugins/Android/libs/jmdns-3.5.8.jar`
  - [x] `Assets/Plugins/Android/libs/arm64-v8a/libadb.so`
  - [x] `Assets/Plugins/Android/java/tdg/oculuswirelessadb/*.java`
  - [x] `Assets/Plugins/Android/AndroidManifest.xml`

---

## 🔨 步骤 1：配置 Build Settings

### 1.1 打开 Build Settings

Unity 菜单栏：**File → Build Settings**

### 1.2 确认平台设置

- **Platform**: 应该显示 `Android`
  - 如果不是，选择 Android 并点击 **Switch Platform**
  - 等待切换完成（可能需要几分钟）

### 1.3 添加场景

在 **Scenes In Build** 列表中：
- 确认 `Assets/Scenes/wireless_adb.unity` 已勾选
- 如果没有，拖拽场景到列表中

### 1.4 连接设备

- 用 USB 连接 Quest 3 到电脑
- 在 Quest 3 中允许 USB 调试
- 在 **Run Device** 下拉框中选择你的 Quest 3 设备

---

## ⚙️ 步骤 2：配置 Player Settings

### 2.1 打开 Player Settings

在 Build Settings 窗口中，点击左下角的 **Player Settings** 按钮

### 2.2 配置 Other Settings（重要！）

在 Inspector 窗口中：

#### **Package Name**（必须设置）
```
com.tdg.quest3wirelessadb
```
⚠️ **必须与 AndroidManifest.xml 中的包名一致！**

#### **Minimum API Level**
```
Android 10.0 (API level 29) 或更高
```

#### **Scripting Backend**
```
IL2CPP
```

#### **Target Architectures**
```
✅ ARM64 (只勾选这个)
❌ ARMv7 (不勾选)
```

### 2.3 配置 XR Settings（如果是 Quest 项目）

#### **XR Plugin Management**
- 切换到 Android 标签
- 确认 **Oculus** 已勾选

---

## 🏗️ 步骤 3：构建 APK

### 方法 A：直接安装到设备（推荐）

1. 确认 Quest 3 已通过 USB 连接
2. 点击 **Build And Run**
3. 如果提示选择保存位置，选择 `build/` 目录
4. 文件名：`quest3_wireless_adb.apk`
5. 等待构建和安装完成（5-10分钟）

### 方法 B：仅构建 APK

1. 点击 **Build**
2. 选择保存位置：`build/quest3_wireless_adb.apk`
3. 等待构建完成
4. 手动安装：
   ```bash
   adb install build/quest3_wireless_adb.apk
   ```

---

## 🔐 步骤 4：授予权限（必须！）

构建和安装完成后，**必须**执行这一步：

```bash
# 1. 确认设备已连接
adb devices

# 应该显示：
# List of devices attached
# 1WMHH8XXXXXX    device

# 2. 授予 WRITE_SECURE_SETTINGS 权限
adb shell pm grant com.tdg.quest3wirelessadb android.permission.WRITE_SECURE_SETTINGS

# 3. 验证权限（可选）
adb shell dumpsys package com.tdg.quest3wirelessadb | grep WRITE_SECURE_SETTINGS

# 应该显示包含 "granted=true" 的行
```

⚠️ **如果不执行此步骤，应用将无法启用无线 ADB！**

---

## 🧪 步骤 5：测试功能

### 5.1 启动应用

在 Quest 3 上：
1. 进入应用库（Library）
2. 在 "Unknown Sources" 或 "All" 中找到 "quest3_wireless_adb"
3. 启动应用

### 5.2 测试 UI

你应该看到：
- ✅ ADB 控制面板浮现在眼前
- ✅ 所有按钮和文本可见
- ✅ 状态指示器（灰色圆圈）
- ✅ 显示 "未初始化" 或 "Not Initialized"

### 5.3 测试启用 ADB

1. **用控制器指向 "启用 ADB" 按钮**
2. **按下扳机键点击**
3. **等待 5-10 秒**
4. **观察变化**：
   - 状态指示器应该变绿
   - IP 地址应该显示（如 `192.168.1.100`）
   - 端口号应该显示（如 `37893`）
   - 状态消息更新

### 5.4 从电脑连接

在电脑终端执行：

```bash
# 使用显示的 IP 和端口
adb connect 192.168.1.100:37893

# 应该显示：
# connected to 192.168.1.100:37893

# 验证连接
adb devices

# 应该显示两个设备（USB + WiFi）：
# 1WMHH8XXXXXX    device         (USB)
# 192.168.1.100:37893    device  (WiFi)
```

### 5.5 测试无线 ADB

```bash
# 1. 断开 USB 线

# 2. 验证无线连接仍然有效
adb devices

# 应该仍然显示：
# 192.168.1.100:37893    device

# 3. 测试 ADB 命令
adb shell pm list packages | grep com.tdg

# 4. 查看日志
adb logcat -s Unity
```

### 5.6 测试禁用 ADB

1. **点击 "禁用 ADB" 按钮**
2. **观察变化**：
   - 状态指示器变红
   - 状态消息显示 "ADB已禁用" 或 "ADB Disabled"

---

## 🐛 常见问题排查

### Q1: 构建失败

**检查 Console 窗口错误信息**

**常见原因：**
- Java 文件编译错误 → 检查包名是否正确
- 缺少依赖库 → 确认 jmdns.jar 存在
- NDK 问题 → 确认只勾选 ARM64

### Q2: 应用闪退

```bash
# 查看崩溃日志
adb logcat -s Unity AndroidRuntime

# 或查看所有日志
adb logcat > crash.log
```

**常见原因：**
- libadb.so 不在正确位置
- Java 类找不到
- 权限未授予

### Q3: UI 显示 "缺少权限"

**解决方法：**
```bash
adb shell pm grant com.tdg.quest3wirelessadb android.permission.WRITE_SECURE_SETTINGS
```

### Q4: 点击按钮没反应

**检查：**
1. UI 是否正确创建（Hierarchy 中有 ADB UI Controller）
2. 组件是否正确关联（Inspector 中所有字段都已填充）
3. 查看 Unity 日志：
   ```bash
   adb logcat -s Unity | grep ADB
   ```

### Q5: 无法发现 IP 地址

**检查：**
1. Quest 是否连接到 WiFi（不是仅 USB）
2. 等待 15 秒后点击 "刷新状态"
3. 查看 mDNS 日志：
   ```bash
   adb logcat | grep JmDNS
   ```

### Q6: 无线连接不稳定

**可能原因：**
- WiFi 信号弱
- 防火墙阻止
- 路由器设置

**解决方法：**
- 靠近路由器
- 禁用防火墙测试
- 重启 Quest 和路由器

---

## 📊 构建输出

成功构建后，你会得到：

```
build/
└── quest3_wireless_adb.apk  (约 50-80 MB)
```

APK 包含：
- Unity 引擎
- Oculus SDK
- 你的脚本和资源
- jmdns 库
- libadb.so 二进制文件

---

## 🎯 测试检查清单

完成以下测试确认功能正常：

- [ ] APK 成功构建
- [ ] APK 成功安装到 Quest 3
- [ ] 权限已授予
- [ ] 应用可以启动
- [ ] UI 正确显示
- [ ] 点击 "启用 ADB" 按钮
- [ ] IP 和端口正确显示
- [ ] 从电脑可以无线连接
- [ ] 断开 USB 后仍可连接
- [ ] ADB 命令正常工作
- [ ] 点击 "禁用 ADB" 可以关闭
- [ ] tcpip 5555 模式测试（可选）

---

## 🎉 成功标志

如果看到以下情况，说明集成成功：

✅ APK 安装无错误
✅ 应用启动不闪退
✅ UI 显示正常
✅ 点击按钮有响应
✅ 能显示 IP 和端口
✅ 电脑能无线连接 Quest 3
✅ 断开 USB 线后仍能使用 ADB

**恭喜！集成完成！🎊**

---

## 📝 调试命令速查

```bash
# 查看设备
adb devices

# 安装 APK
adb install quest3_wireless_adb.apk

# 卸载应用
adb uninstall com.tdg.quest3wirelessadb

# 授予权限
adb shell pm grant com.tdg.quest3wirelessadb android.permission.WRITE_SECURE_SETTINGS

# 查看日志
adb logcat -s Unity
adb logcat | grep -E "ADB|JmDNS"

# 无线连接
adb connect <IP>:<Port>

# 断开无线连接
adb disconnect <IP>:<Port>

# 查看应用信息
adb shell dumpsys package com.tdg.quest3wirelessadb

# 清除应用数据
adb shell pm clear com.tdg.quest3wirelessadb
```

---

**下一步：开始构建！**
